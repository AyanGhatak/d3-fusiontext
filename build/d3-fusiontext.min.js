(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("fusioncharts-smartlabel")):"function"==typeof define&&define.amd?define(["exports","d3-selection","fusioncharts-smartlabel"],e):e(t.d3=t.d3||{},t.d3,t.d3)})(this,function(t,e,i){"use strict";function n(){this.config=s(),this.graphics={},this.measurement={}}i="default"in i?i["default"]:i;var r,o={mergeRecursive:function x(t,e){var i;for(i in e)t[i]instanceof Object?x(t[i],e[i]):t[i]=e[i]},serialize:function(){},isObject:function(t){return"object"==typeof t},extend2:function(){}},a=1,s=function(){return{label:{customTagName:"FT",customTagClassName:"custom-label",text:"",className:"label",style:{"font-size":"12px"},maxDimensions:{width:1600,height:900},valign:"middle"},margin:{left:0,right:0,top:0,bottom:0},padding:{left:0,right:0,top:0,bottom:0},interaction:{hide:!1,listeners:[{action:"click"}],tooltip:{hide:!1,text:"ABC"},className:"fusioncharts-navigator-standardTimeZone-tracker-rect"+a,style:{fill:"rgba(192,192,192,0)","stroke-width":"0",cursor:"pointer"}},labelBound:{hide:!0,className:"fusioncharts-navigator-standardTimeZone-label-bound"+a,style:{fill:"NONE","stroke-width":"1",stroke:"#000"},customLogicalSpace:r,defaultConfig:{pathFn:function(t,e,i,n){return["M",t,e,"L",t+i,e,"L",t+i,e+n,"L",t,e+n,"Z"]},getLogicalSpace:function(t,e,i){var n=2*i["stroke-width"];return t+=n,e+=n,{width:t,height:e}}},customPathFn:r}}};document&&document.write('<script src="http://'+(location.host||"localhost").split(":")[0]+':35729/livereload.js?snipver=1"></script>');var l,h=window,c="",u="-",g=Math,p=g.max,d=h.String,f=h.parseFloat,m=h.getComputedStyle;n.prototype.margin=function(t){return t&&o.mergeRecursive(this.config.margin,t),this},n.prototype.padding=function(t){return t&&o.mergeRecursive(this.config.padding,t),this},n.prototype.label=function(t,e,i){var n=this.config.label;return t&&(n.text=t),e&&o.mergeRecursive(n,e),i&&i.call(this),this},n.prototype.getSmartLabelInstance=function(t){return this.smartLabel||(this.smartLabel=t||new i((new Date).getTime())),this.smartLabel},n.prototype.getConfig=function(t){return this.config[t]},n.prototype.getParentSelection=function(t){return t&&(this.selection=t),this.selection},n.prototype.getStubSelection=function(t,e,i,n,r){n?n[1]&&(n=" "+n[1]):n=c;var o,a=e+n;return this._group||(this._group=[]),this._group[r]||(this._group[r]=t.append("g")),o=this._group[r].attr("class",a),i&&i[2]&&this.recurse(this.normalizeStyle(i[2]),o,"style"),{selection:o,style:this.getSmartComputedStyle(o,a)}},n.prototype.getSmartComputedStyle=function(t,e){var i,n,r,a="W",s={"fill-opacity":0},l="string"==typeof e?e:void 0;return i=t.append("text").text(a),l?i.attr("class",l):"object"==typeof e&&(delete e["fill-opacity"],o.extend2(s,e)),this.recurse(s,i,"style"),n=window.getComputedStyle(i.node()),r={fontSize:n.fontSize,fontFamily:n.fontFamily,fontWeight:n.fontWeight,fontStyle:n.fontStyle},i.remove(),r},n.prototype.normalizeStyle=function(t){var e,i,n=t.replace(/\s/g,"").split(new RegExp(/([\w\-]+):([a-z\s\d]+);/,"ig")).filter(Boolean),r={};for(e=0,i=n.length;i>e;e+=1)r[n[e]]=n[++e];return r},n.prototype.recurse=function(t,e,i){var n;for(n in t)e[i].call(e,n,t[n])},n.prototype.parsedText=function(){var t,e,i,n,r,o,a,s,h,g,p,d=this.config.label,f=d.text,m=d.customTagName,y=d.customTagClassName,x=this.textArr,b=this.getParentSelection(),w=[],S=0,v=0,T=this.getSmartLabelInstance();for(x=this.textArr=[],w.push(this.getStubSelection(b,d.className,d.style,void 0,v)),i=f.split(new RegExp("(<"+m+")([^>]*)>|(</"+m+">)","g")),n="<"+m,o="</"+m+">",T.useEllipsesOnOverflow(1),s=0,p=i.length;p>s;s+=1)(t=i[s])!==l&&(t===n?(S+=1,a=y+u+v++,r=i[++s],w[S]=this.getStubSelection(w[S-1].selection,a,new RegExp("\\sstyle=([\"'])([^\\1]+)\\1","g").exec(r),new RegExp("class=[\"']([a-z\\d\\s]+)[\"']","gi").exec(r),v)):t===o?S-=1:t!==c&&(e=w[S],h=i[s],T.setStyle(e.style),g=T.getOriSize(h||c),x.push({selection:e.selection,oriText:h,text:h,oriWidth:g.width,width:g.width,oriHeight:g.height,height:g.height})));return x},n.prototype.getLogicalSpace=function(t,e){t&&this.getParentSelection(t);var i,n,r,o,a,s,l=this.config,h=this.getSmartLabelInstance(),c=l.label.maxDimensions,u=l.margin,g=u.left+u.right,d=u.top+u.bottom,f=(e&&e.width||c.width)-g,m=(e&&e.height||c.height)-d,y=l.labelBound,x=y.customLogicalSpace||y.defaultConfig.getLogicalSpace,b=this.parsedText(),w=f,S=0;for(o=0,a=b.length;a>o;o+=1)s=b[o],(s.oriWidth>f||s.oriHeight>m)&&(i=h.getSmartText(s.oriText,w,m),s.text=i.text,s.width=i.width,s.height=i.height),w-=s.width,S=p(S,s.height);return n=S,r=f-w,y.hide?{width:r+g,height:n+d}:x(n,r,y.style)},n.prototype.tuneText=function(t,e){var i,n=+t.attr("x"),r=+t.attr("y"),o=m(t.node(),c),a=d(e.text).split(/\n|<br\s*?\/?>/gi),s=o?f(o.getPropertyValue("font-size")):10,l=1.2*s,h=this.config.label.valign;return h="top"===h?-.5:"bottom"===h?.5:0,t.selectAll("tspan").data(a).call(this.updateTuning,n,l,a,h).enter().append("tspan").call(this.updateTuning,n,l,a,h),i=t.node().getBBox(),t.select("tspan").attr("dy",r-(i.y+i.height/2)),(a.length-1)*l},n.prototype.updateTuning=function(t,i,n,r,o){return t.each(function(t,a){e.select(this).attr("x",i).attr("dy",a?n:n*r.length*o).text(r[a])})},n.prototype.setDrawingConfiguration=function(t,e,i,n){var r=this.measurement;return o.isObject(t)&&(e=t.y,i=t.width,n=t.height,t=t.x),r.x=t,r.y=e,r.width=i,r.height=n,this},n.prototype.draw=function(){return this.drawLabelBound.apply(this,arguments).drawLabel.apply(this,arguments).drawTracker.apply(this,arguments)},n.prototype.drawLabelBound=function(){return this},n.prototype.drawLabel=function(t,e){e&&this.setDrawingConfiguration(e);var i,n,r,o,a,s,l,h,c,u,g=this.graphics,p=g.labelArr||(g.labelArr=[]),d=this.measurement,f=this.config.margin;if(i=void 0===i?d.x:i,n=void 0===n?d.y:n,a=void 0===a?d.width:a,s=void 0===s?d.height:s,this.getLogicalSpace(this.getParentSelection(t),{width:a,height:s}),u=this.textArr,i+=f.left,n+=f.top,c=i,!a||!s||isFinite(i)&&isFinite(n)){for(r=0,o=u.length;o>r;r+=1)l=u[r],(h=p[r])||(p[r]=h=l.selection.append("text")),i=c,h.attr("x",i).attr("y",n),n+=this.tuneText(h,l),c+=l.width;return this}},n.prototype.drawTracker=function(){return this},n.prototype.transform=function(t){return this.getParentSelection().attr("transform",t)};var y=function(){return new n};t.fusiontext=y,Object.defineProperty(t,"__esModule",{value:!0})});